<!doctype html>

<meta charset="utf-8">
<script>
	if (typeof Promise === 'undefined')
		document.write('<script src="../node_modules/bluebird/js/browser/bluebird.core.js"><\/script>');
</script>
<script>
	if (typeof fetch === 'undefined')
		document.write('<script src="../node_modules/whatwg-fetch/fetch.js"><\/script>');
</script>
<script defer src="../node_modules/construct-style-sheets-polyfill/dist/adoptedStyleSheets.js"></script>
<script>
	// TODO IE11 URL polyfill testing
	// if (typeof URL === 'undefined')
	//	document.write()
</script>

<link rel="stylesheet" type="text/css" href="../node_modules/mocha/mocha.css"/>
<script src="../node_modules/mocha/mocha.js"></script>

<script src="../dist/system.js"></script>
<script src="../dist/extras/use-default.js"></script>
<script src="../dist/extras/amd2.js"></script>
<script src="../dist/extras/named-register.js"></script>

<script>
  mocha.setup('tdd');

  function createNotEqualError(a, b) {
    return new Error('Expected "' + a + '" to be "' + b + '"');
  }

  self.baseURL = location.href.substr(0, location.href.lastIndexOf('/') + 1);
  self.rootURL = location.href.substr(0, location.href.substr(0, location.href.lastIndexOf('/')).lastIndexOf('/') + 1);
  self.assert = {
    ok: function (val) {
      this.equal(!!val, true);
      return val;
    },
    equal: function equal(a, b) {
      if (a !== b)
        throw createNotEqualError(a, b);
      return a;
    },
    deepEqual: function deepEqual(a, b) {
      if (a !== b) {
        if (typeof a !== typeof b) {
          throw createNotEqualError(a, b);
        }

        if (typeof a === "object") {
          if (a === null || b === null) {
            throw createNotEqualError(a, b);
          }

          const A = a.constructor;
          const B = b.constructor;
          if (A !== B) {
            throw createNotEqualError(a, b);
          }

          if (A === Array) {
            let L = a.length;
            if (b.length !== L) {
              throw createNotEqualError(a, b);
            }

            let i = -1;
            while (++i < L) {
              deepEqual(a[i], b[i]);
            }
          }

          if (A === Object || A == null) {
            const propsA = Object.keys(A);
            if (propsA.length !== Object.keys(B).length) {
              throw createNotEqualError(a, b);
            }

            propsA.forEach(function(pA) {
              if (!Object.prototype.hasOwnProperty.call(b, pA)) {
                throw createNotEqualError(a, b);
              }

              deepEqual(a[pA], b[pB]);
            });
          }
        }
      }

      return a;
    },
    fail: function (msg) {
      throw new Error(msg);
    }
  };

  System.import("./browser/amd2.js")
    .then(function() {
      mocha.run(function(failures) {
        fetch(failures ? "/error" : "/done");
      });
    });
</script>

<div id="mocha"></div>

<script>

	function doTests(funs) {


      const testFuns = funs.slice();
      return;
		return new Promise(function(resolve) {
			
			nextTest();

			function nextTest() {
				if(!testFuns.length) {
					resolve();
				} else {
					const test = testFuns.shift();
					Promise.resolve(test()).then(logModule, logModuleError);
				}
			}
			
			function logModule(exported) {
				console.log("Loaded " + exported);
				nextTest();
			}

			function logModuleError(error) {
				console.log("Failed " + error);
				nextTest();
			}
		});
	}
	
	// ---
	function assertNormalizeDep(id, expectedId) {
		let normalizedId = System.amd.normalizeDep(id);
		if (normalizedId) {
			normalizedId = normalizedId.replace(/_unnormalized\d+$/, "_unnormalized");
		}

		assert.equal(normalizedId, expectedId);
	}

	function assertResolve(id, expectedUrl) {
		let url = System.resolve(id);
		if (url) {
			url = url.replace(/_unnormalized\d+$/, "_unnormalized");
		}

		assert.equal(url, expectedUrl);
	}

	function assertCanonicalId(url, expectedId) {
		assert.equal(System.canonicalIdByUrl(url), expectedId);
	}
    
	doTests([
		function() {
			return System.import("fixtures/pluginA!foo-resource");
		},
		function() {
			return System.import("fixtures/pluginA!foo-resource");
		},
		function() {
			return System.import("fixtures/pluginA!bar-resource");
		},
		function() {
			return assert.equal(
				require.toUrl("fixtures/module-dep.css"), 
				baseUrl + "src/temp/tests/module-dep.css");
		},
		function() {
            assertNormalizeDep("fixtures/anonymous", "fixtures/anonymous.js");
            assertNormalizeDep("fixtures/anonymous.js", "fixtures/anonymous.js");
            assertNormalizeDep("fixtures-global-alias", "fixtures.js");
            assertNormalizeDep("fixtures-global-alias/anonymous", "fixtures/anonymous.js");
            assertNormalizeDep("fixtures/bundleA", "fixtures/bundleA.js");
            assertNormalizeDep("fixtures/pluginA", "fixtures/pluginA.js");
            assertNormalizeDep("fixtures/pluginA!foo", "fixtures/pluginA.js!foo");
            assertNormalizeDep("fixtures/plugin-unloaded.js!foo", "fixtures/plugin-unloaded.js!foo_unnormalized");
		},
		function() {
            assertResolve("fixtures/anonymous.js", baseUrl + "src/temp/tests/anonymous.js#!mid=fixtures/anonymous.js");
			assertResolve("fixtures/anonymous", baseUrl + "src/temp/tests/anonymous.js#!mid=fixtures/anonymous.js");
			assertResolve("fixtures/module-dep", baseUrl + "src/temp/tests/module-dep.js#!mid=fixtures/module-dep.js");
			assertResolve("fixtures-global-alias/anonymous", baseUrl + "src/temp/tests/anonymous.js#!mid=fixtures/anonymous.js");
            assertResolve("fixtures/pluginA.js!foo", baseUrl + "src/temp/tests/pluginA.js#!mid=fixtures/pluginA.js!foo");
			assertResolve("fixtures/pluginA!foo", baseUrl + "src/temp/tests/pluginA.js#!mid=fixtures/pluginA.js!foo");
            assertResolve("fixtures/pluginA!foo.js", baseUrl + "src/temp/tests/pluginA.js#!mid=fixtures/pluginA.js!foo");
			assertResolve("fixtures/plugin-unloaded!foo", baseUrl + "src/temp/tests/plugin-unloaded.js#!mid=fixtures/plugin-unloaded.js!foo_unnormalized");
			assertResolve("bundleA-bundled-module1", baseUrl + "src/temp/tests/bundleA.js#!mid=fixtures/bundleA.js#!mid=bundleA-bundled-module1.js");
		},
		function() {
			assertCanonicalId(baseUrl + "src/temp/tests/anonymous.js", "fixtures/anonymous.js");

			assertCanonicalId("foo#!mid=a/b/c", "a/b/c");
            assertCanonicalId("foo.js#!mid=a/b/c", "a/b/c");
            assertCanonicalId("foo", null);
			assertCanonicalId("foo.js", null);

			assertCanonicalId(baseUrl + "src/temp/tests/bundleA.js#!mid=fixtures/bundleA#!mid=bundleA-bundled-module1.js",
				"bundleA-bundled-module1.js");
		},
		function() {
			return new Promise(function(resolve, reject) {
				// Async require
				System.amd.require([
					"fixtures/anonymous",
					"fixtures/module-dep"
				], function(anonymous, dep) {
					
					assert.ok(/^anonymous:/.test(anonymous));
					assert.ok(/^module-dep:/.test(dep));
					
					resolve();
				}, reject);
			});
		},
		function() {
			return new Promise(function(resolve, reject) {
				System.amd.require([
					"fixtures/anonymous",
					"fixtures/module-dep"
				], function(anonymous, dep) {
					
					// Sync require
					assert.equal(System.amd.require("fixtures/anonymous"), anonymous);
					assert.equal(System.amd.require("fixtures/module-dep"), dep);
					
					resolve();
				}, reject);
			});
		},
        function() {
            const refNode = System.amd.get("fixtures/anonymous", true);
            assert.equal(refNode.normalizeDep("./Model"), "fixtures/Model.js");
            assert.equal(refNode.normalizeDep("./Model.js"), "fixtures/Model.js");
        }
	]);
</script>
