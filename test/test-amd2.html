<!doctype html>

<meta charset="utf-8">
<script>
	if (typeof Promise === 'undefined')
		document.write('<script src="../node_modules/bluebird/js/browser/bluebird.core.js"><\/script>');
</script>
<script>
	if (typeof fetch === 'undefined')
		document.write('<script src="../node_modules/whatwg-fetch/fetch.js"><\/script>');
</script>
<script defer src="../node_modules/construct-style-sheets-polyfill/dist/adoptedStyleSheets.js"></script>
<script>
	// TODO IE11 URL polyfill testing
	// if (typeof URL === 'undefined')
	//	document.write()
</script>

<link rel="stylesheet" type="text/css" href="../node_modules/mocha/mocha.css"/>
<script src="../node_modules/mocha/mocha.js"></script>

<script src="../dist/system.js"></script>
<script src="../dist/extras/use-default.js"></script>
<script src="../dist/extras/amd2.js"></script>
<script src="../dist/extras/named-register.js"></script>

<script>
  mocha.setup('tdd');

  self.baseURL = location.href.substr(0, location.href.lastIndexOf('/') + 1);
  self.rootURL = location.href.substr(0, location.href.substr(0, location.href.lastIndexOf('/')).lastIndexOf('/') + 1);
  self.assert = {
    ok: function (val) {
      this.equal(!!val, true);
      return val;
    },
    equal: function equal(a, b) {
      if (a !== b)
        throw new Error('Expected "' + a + '" to be "' + b + '"');
      return a;
    },
    fail: function (msg) {
      throw new Error(msg);
    }
  };

  System.import("./browser/amd2.js")
    .then(function() {
      mocha.run(function(failures) {
        fetch(failures ? "/error" : "/done");
      });
    });
</script>

<div id="mocha"></div>

<script>

	function doTests(funs) {


		const testFuns = funs.slice();
      return;
		return new Promise(function(resolve) {
			
			nextTest();

			function nextTest() {
				if(!testFuns.length) {
					resolve();
				} else {
					const test = testFuns.shift();
					Promise.resolve(test()).then(logModule, logModuleError);
				}
			}
			
			function logModule(exported) {
				console.log("Loaded " + exported);
				nextTest();
			}

			function logModuleError(error) {
				console.log("Failed " + error);
				nextTest();
			}
		});
	}
	
	// ---
	function assertNormalizeDep(id, expectedId) {
		let normalizedId = System.amd.normalizeDep(id);
		if (normalizedId) {
			normalizedId = normalizedId.replace(/_unnormalized\d+$/, "_unnormalized");
		}

		assert.equal(normalizedId, expectedId);
	}

	function assertResolve(id, expectedUrl) {
		let url = System.resolve(id);
		if (url) {
			url = url.replace(/_unnormalized\d+$/, "_unnormalized");
		}

		assert.equal(url, expectedUrl);
	}

	function assertCanonicalId(url, expectedId) {
		assert.equal(System.canonicalIdByUrl(url), expectedId);
	}

	let amdAnonymousLoad1;
	doTests([
		function() {
			return System.import("amd-tests/amd-anonymous").then(function(value) {
				return (amdAnonymousLoad1 = value);
			});
		},
		function() {
			return System.import("amd-tests/amd-module-dep");
		},
		function() {
			return System.import("amd-tests-global-alias/amd-anonymous").then(function(amdAnonymousLoad2) {
				return assert.equal(amdAnonymousLoad2, amdAnonymousLoad1);
			});
		},
		function() {
			return System.import("amd-tests/amd-scoped-dep");
		},
		function() {
			return System.import("amd-tests/amd-bundleA").then(function(value) {
				assert.equal(value, undefined);
			});
		},
		function() {
			return System.import("amd-tests/amd-pluginA!foo-resource");
		},
		function() {
			return System.import("amd-tests/amd-pluginA!foo-resource");
		},
		function() {
			return System.import("amd-tests/amd-pluginA!bar-resource");
		},
		function() {
			return System.import("amd-tests/amd-plugin-dep");
		},
		function() {
			return System.import("amd-tests/amd-shimmed").then(function(value) {
				return assert.equal(value, "amd-shimmed");
			});
		},
		function() {
			return assert.equal(
				require.toUrl("amd-tests/amd-module-dep.css"), 
				baseUrl + "src/temp/tests/amd-module-dep.css");
		},
		function() {
            assertNormalizeDep("amd-tests/amd-anonymous", "amd-tests/amd-anonymous.js");
            assertNormalizeDep("amd-tests/amd-anonymous.js", "amd-tests/amd-anonymous.js");
            assertNormalizeDep("amd-tests/amd-module-dep", "amd-tests/amd-module-dep.js");
            assertNormalizeDep("amd-tests-global-alias", "amd-tests.js");
            assertNormalizeDep("amd-tests-global-alias/amd-anonymous", "amd-tests/amd-anonymous.js");
            assertNormalizeDep("amd-tests/amd-bundleA", "amd-tests/amd-bundleA.js");
            assertNormalizeDep("amd-tests/amd-pluginA", "amd-tests/amd-pluginA.js");
            assertNormalizeDep("amd-tests/amd-pluginA!foo", "amd-tests/amd-pluginA.js!foo");
            assertNormalizeDep("amd-tests/amd-plugin-unloaded.js!foo", "amd-tests/amd-plugin-unloaded.js!foo_unnormalized");
		},
		function() {
            assertResolve("amd-tests/amd-anonymous.js", baseUrl + "src/temp/tests/amd-anonymous.js#!mid=amd-tests/amd-anonymous.js");
			assertResolve("amd-tests/amd-anonymous", baseUrl + "src/temp/tests/amd-anonymous.js#!mid=amd-tests/amd-anonymous.js");
			assertResolve("amd-tests/amd-module-dep", baseUrl + "src/temp/tests/amd-module-dep.js#!mid=amd-tests/amd-module-dep.js");
			assertResolve("amd-tests-global-alias/amd-anonymous", baseUrl + "src/temp/tests/amd-anonymous.js#!mid=amd-tests/amd-anonymous.js");
            assertResolve("amd-tests/amd-pluginA.js!foo", baseUrl + "src/temp/tests/amd-pluginA.js#!mid=amd-tests/amd-pluginA.js!foo");
			assertResolve("amd-tests/amd-pluginA!foo", baseUrl + "src/temp/tests/amd-pluginA.js#!mid=amd-tests/amd-pluginA.js!foo");
            assertResolve("amd-tests/amd-pluginA!foo.js", baseUrl + "src/temp/tests/amd-pluginA.js#!mid=amd-tests/amd-pluginA.js!foo");
			assertResolve("amd-tests/amd-plugin-unloaded!foo", baseUrl + "src/temp/tests/amd-plugin-unloaded.js#!mid=amd-tests/amd-plugin-unloaded.js!foo_unnormalized");
			assertResolve("amd-bundleA-bundled-module1", baseUrl + "src/temp/tests/amd-bundleA.js#!mid=amd-tests/amd-bundleA.js#!mid=amd-bundleA-bundled-module1.js");
		},
		function() {
			assertCanonicalId(baseUrl + "src/temp/tests/amd-anonymous.js", "amd-tests/amd-anonymous.js");
			assertCanonicalId(baseUrl + "src/temp/tests/amd-module-dep.js", "amd-tests/amd-module-dep.js");

			assertCanonicalId("foo#!mid=a/b/c", "a/b/c");
            assertCanonicalId("foo.js#!mid=a/b/c", "a/b/c");
            assertCanonicalId("foo", null);
			assertCanonicalId("foo.js", null);

			assertCanonicalId(baseUrl + "src/temp/tests/amd-bundleA.js#!mid=amd-tests/amd-bundleA#!mid=amd-bundleA-bundled-module1.js",
				"amd-bundleA-bundled-module1.js");
		},
		function() {
			return new Promise(function(resolve, reject) {
				// Async require
				System.amd.require([
					"amd-tests/amd-anonymous",
					"amd-tests/amd-module-dep"
				], function(anonymous, dep) {
					
					assert.ok(/^amd-anonymous:/.test(anonymous));
					assert.ok(/^amd-module-dep:/.test(dep));
					
					resolve();
				}, reject);
			});
		},
		function() {
			return new Promise(function(resolve, reject) {
				System.amd.require([
					"amd-tests/amd-anonymous",
					"amd-tests/amd-module-dep"
				], function(anonymous, dep) {
					
					// Sync require
					assert.equal(System.amd.require("amd-tests/amd-anonymous"), anonymous);
					assert.equal(System.amd.require("amd-tests/amd-module-dep"), dep);
					
					resolve();
				}, reject);
			});
		},
        function() {
            const refNode = System.amd.get("amd-tests/amd-anonymous", true);
            assert.equal(refNode.normalizeDep("./Model"), "amd-tests/Model.js");
            assert.equal(refNode.normalizeDep("./Model.js"), "amd-tests/Model.js");
        }
	]);
</script>
