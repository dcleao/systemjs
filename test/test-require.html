<!doctype html>

<meta charset="utf-8">
<script>
	if (typeof Promise === 'undefined')
		document.write('<script src="../node_modules/bluebird/js/browser/bluebird.core.js"><\/script>');
</script>
<script>
	if (typeof fetch === 'undefined')
		document.write('<script src="../node_modules/whatwg-fetch/fetch.js"><\/script>');
</script>
<script defer src="../node_modules/construct-style-sheets-polyfill/dist/adoptedStyleSheets.js"></script>
<script>
	// TODO IE11 URL polyfill testing
	// if (typeof URL === 'undefined')
	//	document.write()
</script>

<script src="../node_modules/mocha/mocha.js"></script>
<script>
	self.assert = {
		ok: function (val) {
			this.equal(!!val, true);
		},
		equal: function equal(a, b) {
			if (a !== b)
				throw new Error('Expected "' + a + '" to be "' + b + '"');
		},
		fail: function (msg) {
			throw new Error(msg);
		}
	};
</script>
<script src="../dist/system.js"></script>
<script src="../dist/extras/named-register.js"></script>
<script src="../dist/extras/use-default.js"></script>
<script src="../src/temp/require.js"></script>

<script>
	System.amd.require.config({
		paths: {
			"amd-tests": "../src/temp/tests"
		},
		"map": {
			"*": {
				"amd-tests-global-alias": "amd-tests"
			},
			"amd-tests/amd-scoped-dep": {
				"A": "amd-tests/amd-dependencyA"
			}
		}
	});

	function doTests(funs) {
		
		const testFuns = funs.slice();

		return new Promise(function(resolve) {
			
			nextTest();

			function nextTest() {
				if(!testFuns.length) {
					resolve();
				} else {
					const test = testFuns.shift();
					Promise.resolve(test()).then(logModule, logModuleError);
				}
			}
			
			function logModule(exported) {
				console.log("Loaded " + exported);
				nextTest();
			}

			function logModuleError(error) {
				console.log("Failed " + error);
				nextTest();
			}
		});
	}
	
	// ---
	function assertResolve(id, expectedUrl) {
		assert.equal(System.resolve(id), expectedUrl)
	}

	function assertUrl(resolvedId, expectedUrl) {
		const node = System.amd.get(resolvedId);
		
		assert.ok(node);
		assert.equal(node.url, expectedUrl);
	}

	function assertCanonicalId(url, expectedId) {
		assert.equal(System.canonicalIdByUrl(url), expectedId);
	}

	const baseUrl = "http://127.0.0.1:8080/";

	doTests([
		function() {
			return System.import("amd-tests/amd-anonymous");
		},
		function() {
			return System.import("amd-tests/amd-module-dep");
		},
		function() {
			return System.import("amd-tests-global-alias/amd-anonymous");
		},
		function() {
			return System.import("amd-tests/amd-scoped-dep");
		},
		function() {
			return System.import("amd-tests/amd-bundleA");
		},
		function() {
			assertResolve("amd-tests/amd-anonymous", "amd-tests/amd-anonymous");
			assertResolve("amd-tests/amd-module-dep", "amd-tests/amd-module-dep");
			assertResolve("amd-tests-global-alias", "amd-tests");
			assertResolve("amd-tests-global-alias/amd-anonymous", "amd-tests/amd-anonymous");
			assertResolve("amd-tests/amd-bundleA", "amd-tests/amd-bundleA");
		},
		function() {
			assertUrl("amd-tests/amd-anonymous", baseUrl + "src/temp/tests/amd-anonymous.js");
			assertUrl("amd-tests/amd-module-dep", baseUrl + "src/temp/tests/amd-module-dep.js");
		},
		function() {
			assertCanonicalId(baseUrl + "src/temp/tests/amd-anonymous.js", "amd-tests/amd-anonymous");
			assertCanonicalId(baseUrl + "src/temp/tests/amd-module-dep.js", "amd-tests/amd-module-dep");

			assertCanonicalId("foo#!cid=a/b/c", "a/b/c");
			assertCanonicalId("foo", null);
		},
		function() {
			return new Promise(function(resolve, reject) {
				System.amd.require([
					"amd-tests/amd-anonymous",
					"amd-tests/amd-module-dep"
				], function(anonymous, dep) {
					
					assert.ok(/^amd-anonymous:/.test(anonymous));
					assert.ok(/^amd-module-dep:/.test(dep));
					
					resolve();
				}, reject);
			});
		},
		function() {
			return new Promise(function(resolve, reject) {
				System.amd.require([
					"amd-tests/amd-anonymous",
					"amd-tests/amd-module-dep"
				], function(anonymous, dep) {
					
					assert.equal(System.amd.require("amd-tests/amd-anonymous"), anonymous);
					assert.equal(System.amd.require("amd-tests/amd-module-dep"), dep);
					
					resolve();
				}, reject);
			});
		}
	]);
</script>
